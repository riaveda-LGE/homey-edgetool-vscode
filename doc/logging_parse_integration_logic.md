# Homey EdgeTool — 로그 파이프라인 요약 (updated 2025-10-25)

이 문서는 **현재 구현된 파서/타임스탬프 보정/로그 병합/페이지네이션** 흐름을 장황하지 않게 정리합니다.  
핵심 원칙은 **입력은 다양해도, 출력/표시는 일관된 시간 기준과 순서**를 보장하는 것입니다.

---

## 1) 전체 흐름 한눈에
1. **프리플라이트(파일 단위)** — 커스텀 파서 적용 여부 결정  
   - 샘플 라인 `sample_lines`개 스캔 → `min_match_ratio` 이상이면 적용  
   - `hard_skip_if_any_line_matches` 중 하나라도 매치되면 **파서 미적용**
2. **라인→엔트리 변환**  
   - 파서 적용 시 `time/process/pid/message` 추출 → `parsed`에 저장  
   - `preserveFullText=true`면 **헤더 복원**: `[{time}] {process}[{pid}]: {message}`로 `text` 재구성 및 `ts` 재계산(헤더 우선)
3. **타입별 로딩(최신→오래된)**  
   - 파일 회전 규칙 인식(`.log` → `.log.1` → `.log.2` …)  
   - **드랍 규칙** 반영:  
     - 빈 줄(`""`)은 스킵  
     - 파서 적용 파일에서 `time/process/pid` **셋 모두 없음**이면 스킵
4. **타임스탬프 정리**  
   - `YearlessStitcher`: 연도 없는 포맷(syslog류)을 **단조 비증가(desc)** 되도록 연결  
     - 같은 초/≤1.5s 지터는 연도 이동 없이 **해당 라인만 1ms 로컬 클램프**  
   - `MonotonicCorrector`: 타입별 시계 흔들림을 전역 오프셋/로컬 클램프로 보정(1ms 그라뉼러리티)
5. **타입별 저장 (최신순)**  
   - 각 타입을 `ts desc`로 정렬해 `<type>.jsonl`로 저장 (`merged/`)  
   - 필요 시 RAW 스냅샷(`<type>.raw.jsonl`)
6. **전역 병합(k-way, 최신→오래된)**  
   - 각 타입에서 100줄씩 스트리밍 → `ts desc` 힙 머지  
   - 타이브레이커: **fileRank asc → filename asc → revIdx asc → typeKey asc → seq asc**
7. **청크/매니페스트 출력 → 페이지 서비스**  
   - `part-000001.ndjson` 등으로 청크화 + `index.json`(총 라인/세그먼트)  
   - 페이지네이션은 **오름차순 인덱스**를 물리 `desc` 저장에 매핑

---

## 2) 커스텀 파서(간단 규칙)
- **파일 매칭:** 파일 **이름(basename)** 만 정규식 또는 리터럴 `^…$`로 매칭
- **필드 추출:** named capture로 `time/process/pid/message` 개별 파싱
- **요구사항 검사:** `requirements.fields`에서 지정한 필드는 **모두 존재**해야 “매치”
- **헤더 복원:** 파서가 message-only를 만들어도 테스트/표시 일관성을 위해 헤더 형식으로 **재구성**하고, `parseTs`를 **헤더 우선**으로 재적용

> `parseTs` 규칙:  
> - ISO8601(Z/±오프셋) 그대로 사용  
> - `YYYY-MM-DD HH:MM:SS(.sss)`(오프셋 없음)는 **UTC 해석**  
> - `Mon DD HH:MM:SS(.sss)` / `MM-DD HH:MM:SS(.sss)`는 **연도만 현재 연도 주입 + UTC 해석** (정렬용, 실제 연도 추정 아님)

---

## 3) 순서/정합성 보장 포인트
- **타입 내부:** 최신→오래된으로 스캔 후 보정 → 저장 시 **`ts desc`** 유지  
- **전역:** k-way로 **`ts desc`** 방출(최신부터)  
- **UI/페이지:** 사용자는 항상 **오름차순 인덱스**로 요청하지만, 내부는 자동으로 `desc` 저장에서 매핑
- **역전 처리:**  
  - 작은 역전(≤1.5s): 전역 오프셋 변경 없이 **해당 라인만 1ms 내림**  
  - 큰 점프: 전역 오프셋을 조정하여 **단조 유지**

---

## 4) 드랍 규칙(실제 파이프라인 & 테스트 기대값 동일)
- **빈 줄**: 항상 제외
- **파서 적용 파일**에서 `time/process/pid` **셋 모두 없음**: 제외  
👉 테스트에서도 동일 필터를 적용해 **원본 vs 복원**을 비교합니다(ANSI/공백 차이 무시).

---

## 5) 워밍업(T0) — 빠른 첫 화면
- 타입 수만큼 균등 할당(+잔여 재분배)으로 꼬리(tail)에서 수집  
- 타입별로 위의 **타임스탬프 보정**을 그대로 수행 후 `ts desc` 정렬  
- k-way로 정확히 **N개**를 만들어 **페이지네이션 warm 버퍼**에 시딩

---

## 6) 파일 선택/리스트업
- 입력은 루트(비재귀)에서 `*.log(.N)/*.txt`만 허용  
- 옵션 화이트리스트는 **basename 정규식**만 지원(`^…`는 정규식, 나머지는 리터럴 고정)

---

## 7) 페이지네이션/필터/검색(요약)
- **readRangeByIdx(s,e)**: 논리 **오름차순** 인덱스 요청 → 물리 `desc` 저장에서 매핑 후 반환  
- **필터**: `msg/proc/pid/src` 지원(콤마로 OR, 공백으로 AND 그룹) — 파일 후보는 `file`(또는 `path`의 basename)만 사용  
- **검색(searchAll)**: 워밍업/파일 기반 공통의 **단일 패스 선형 스캔**, 옵션으로 regex/범위/top 지원

---

## 8) 리버스 모드(디버그용)
- `reverse=true`이면 **전역 ts 오름차순**으로 k-way 병합(파일 단위가 아닌 전역 시계 기준)

---

## 9) 산출물
- **중간물**: `merged/<type>.jsonl` (최신순), 선택적으로 `t1_raw/<type>.raw.jsonl`  
- **최종물**: `part-XXXXXX.ndjson` + `index.json`(총 라인/세그먼트)

---

## 10) 테스트 커버리지(핵심만)
- 병합 결과를 페이지 서비스로 **오름차순** 읽어 검증(중간/말단 구간 포함)  
- 전역 결과에서 **프로세스별 파일로 역복원** → **원본과 라인-대-라인 비교**  
- 비교 시 **드랍 규칙 반영 + ANSI/공백 무시**

---

### 구현에서 기억할 것
- 파일 매칭/화이트리스트/프리플라이트는 **항상 basename 기준**  
- 헤더 복원 시 **헤더 기반 `parseTs`가 우선**, 실패 시에만 full-line 파싱 사용  
- `YearlessStitcher`와 `MonotonicCorrector`의 적용 순서: **스티치 → 단조 보정**