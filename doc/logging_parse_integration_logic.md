# Homey EdgeTool 로그 병합 모드 & 정렬 가이드

> 이 문서는 **T1(기본 경로)**, **Reverse 모드(검증용)**, **Warmup(선행 프리뷰)**의 차이와
> 각 단계의 **정렬 방향(오름/내림)**, **중간 산출물**, **타임존(TZ) 보정** 여부를 한눈에 정리합니다.
> 또한 k-way 힙의 **tie‑breaker 부호 정리** 권장 diff를 포함합니다.

---

## TL;DR

- **T1(기본)**: _타입별 최신→오래된_ 로딩 → **TZ 보정** → **타입별 JSONL(최신순)** 저장 →
  JSONL에서 **최신→오래된(전역)** k-way 병합 → UI/콜백 배출.
- **Reverse 모드**: **모든 파일을 전역 타임스탬프 ASC(오래된→최신)**로 k-way 병합 **(TZ 보정 없음, 중간파일 없음)**.
  현재 **프로덕션 경로에서는 미사용(검증/디버그 전용)**.
- **Warmup(선행 프리뷰)**: 타입별로 최근 꼬리만 살짝 읽어 **TZ 보정 후 최신순** 정렬 → 소량 k-way →
  **즉시 미리보기용 배출**(디스크 산출물 없이 메모리만). T1 완료 시 파일 기반으로 전환.

---

## 1) T1(기본) – 타입별 로딩 → TZ 보정 → JSONL 저장

- **입력 읽기**: 파일별로 **뒤에서 앞으로(최신→오래된)** 역방향 라인 리더.
- **타입별 버퍼**: 읽은 순서를 그대로 쌓아 **최신→오래된(내림차순)**.
- **TZ 보정**: `TimezoneCorrector`로 국소 소급 보정 적용.
- **저장**: 타입별로 ts **내림차순(최신→오래된)** 정렬 후 `merged/<type>.jsonl`에 저장.

```
[파일별 tail]  ──►  [type 버퍼: 최신→오래된]  ──(TZ)──►  [type.jsonl: ts desc(최신순)]
```

### 1‑B) T1(기본) – 최종 k‑way 병합

- 입력: `merged/*.jsonl` (각 파일 **최신→오래된** 정렬로 저장됨).
- 커서: 각 타입에서 **앞에서부터**(=가장 최신부터) 100줄씩 가져옴.
- 힙: **ts 내림차순(큰 값 우선 = 최신 우선)** k‑way.
- **출력/배출**: **최신→오래된**(내림차순)으로 onBatch 콜백.

---

## 2) Reverse 모드 (`reverse:true`) – 전역 ASC 병합 (검증/디버그용)

- **읽기**: 모든 입력 로그를 **정방향(파일 앞→뒤)**.
- **TZ 보정**: **없음**.
- **중간산출물(JSONL/manifest)**: **없음** (디스크에 남기지 않음).
- **힙 병합**: **ts 오름차순(작은 값 우선 = 오래된 우선)** k‑way.
- **용도**: 파서/타임스탬프 정합 **검증 전용** 루트.
- **실사용 경로**: 현재 **미사용** (UI/테스트에서 기본적으로 호출하지 않음).

> 정리: “모든 로그를 한 줄 타임라인으로 **오래된→최신** 합쳐 **빠르지 않지만 보정 없는** 진짜 원시 정렬을 보고 싶을 때” 쓰는 Dev 전용 모드.

---

## 3) Warmup(선행 빠른 프리뷰)

- **목표**: 사용자에게 “몇 백~천 줄 정도의 최신 미리보기”를 **즉시** 보여주기.
- **읽기**: 타입별 tail에서 균등/재분배로 필요한 줄 수만 **최신→오래된** 수집.
- **TZ 보정**: **적용**.
- **정렬**: 타입별 버퍼를 **최신순(ts desc)** 정렬 후 소량 k‑way로 합침.
- **배출**: 메모리에서 **즉시** onWarmupBatch/onBatch로 전달(파일 저장 없음).
- **전환**: 이후 **T1 완료 시** 파일 기반(PagedReader)으로 **스위치**.

---

## 4) 한눈에 비교표

| 항목 | T1(타입별 로딩) | T1(최종 k‑way) | Reverse 모드 | Warmup |
|---|---|---|---|---|
| 입력 읽기 방향 | 파일별 **역방향**(최신→오래된) | JSONL **순방향** | 파일별 **정방향** | tail from files |
| 내부 버퍼 정렬 | 타입별 **최신→오래된** | 타입별 JSONL **최신→오래된** | (없음) | 타입별 **최신→오래된** |
| 힙 우선순위(ts) | 저장 전에 정렬만 | **내림차순(최신 우선)** | **오름차순(오래된 우선)** | **내림차순(최신 우선)** |
| TZ 보정 | **적용** | (이미 적용된 결과 사용) | **미적용** | **적용** |
| 중간 산출물 | `merged/<type>.jsonl` | 사용 | **없음** | **없음** |
| 배출 순서 | (없음) | **최신→오래된** | **오래된→최신** | **최신→오래된** |
| 주 용도 | 영속 인덱스 생성 | 최종 결과/페이징 | 검증/디버그 | 초기 미리보기 |

---

## 5) 힙 tie‑breaker(타이브레이커) 규칙 요약

> 공통: `MaxHeap(cmp)`를 사용하므로 “**cmp(a,b) > 0이면 a가 더 우선**”입니다.

### T1 최종 k‑way (최신 우선)

1) **ts 내림차순**: `return a.ts - b.ts`  
2) **fileRank 오름차순**(숫자 작을수록 최신 파일): `return bRank - aRank`  
3) **filename 오름차순**(사전순): **`return aFile < bFile ? 1 : -1` (권장 부호)**  
4) **revIdx 오름차순**: `return bRev - aRev`  
5) **typeKey 오름차순**: **`return aType < bType ? 1 : -1` (권장 부호)**  
6) **seq 오름차순**(같은 커서 내 먼저 읽힌 것): `return b.seq - a.seq`

> **왜 filename/typeKey는 부호 반전이 필요한가?**  
> `MaxHeap`에서 “작은 문자열이 우선”을 표현하려면 `a < b`일 때 **양수**를 반환해야 합니다.
> 따라서 `a < b ? 1 : -1` 형태가 되어야 일관성이 맞습니다.


## 7) 실사용 여부 (Reverse 모드)

- 현재 제공된 소스 기준으로는 **Reverse 모드가 호출되는 경로가 없음**.
  - `LogViewerPanelManager.startFileMerge()`는 `reverse`를 전달하지 않음 → 항상 T1 경로.
  - 통합 테스트(`LogFileIntegration.test.ts`)도 `reverse:true`를 사용하지 않음.
- 따라서 Reverse는 **개발/검증용 기능 플래그**에 가깝습니다. 필요 시 주석으로 dev‑only 표기하거나
  작은 회귀 테스트를 추가해 “정렬만 비교(TZ 제외)” 용도로 유지하는 것을 권장합니다.

---

### 부록: 정렬/흐름 치트시트

- **파일 읽기**  
  - T1: 파일별 **역방향**(tail→head) → 타입별 버퍼 **최신→오래된**  
  - Reverse: 파일별 **정방향**(head→tail) → 힙에서 **오래된 우선**  
  - Warmup: 타입별 tail에서 일부만 **최신→오래된**

- **최종 배출 순서**  
  - T1/ Warmup: **최신→오래된**  
  - Reverse: **오래된→최신**

- **TZ 보정**  
  - T1/ Warmup: **적용**  
  - Reverse: **미적용**
